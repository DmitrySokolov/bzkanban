<html>
    <head>
        <title>Bugzilla Kanban Board</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

        <style>
            body {
                background-color: ghostwhite;
                font-family: sans-serif;
            }
            #board {
                width: 100%;
                display: flex;
            }
            #board div {
                flex: 1;
                vertical-align: top;
            }
            .board-column-title {
                text-align: center;
                font-weight: bold;
            }
            .card {
                background-color: white;
                border-width: 1px;
                border-color: lightgrey;
                border-style: solid;
                padding: 10px;
                margin: 5px;
                font-size: small;
            }
            .card-meta {
                font-size: x-small;
                text-align: right;
                color: lightgrey;
                padding-top: 5px;
            }
            .card:hover {
                box-shadow: 0px 0px 1px grey;
            }
            .enhancement {
                border-right-color: greenyellow;
                border-right-width: 4px;
                border-right-style: solid;
            }
            .critical {
                border-right-color: red;
                border-right-width: 4px;
                border-right-style: solid;
            }
            .P1 {
                border-left-color: orange;
                border-left-width: 4px;
                border-left-style: solid;
            }
            #UNCONFIRMED {
                border-style: solid;
                border-width: 1;
	        }	
            #CONFIRMED {
                border-style: solid;
                border-width: 1;
	        }	
            #IN_PROGRESS {
                border-style: solid;
                border-width: 1;
	        }	
            #RESOLVED {
                border-style: solid;
                border-width: 1;
	        }	
            #VERIFIED {
                border-style: solid;
                border-width: 1;
	        }	
            fieldset {
                border-width: 1;
                border-style: solid;
                border-color: lightgrey;
                background-color: white;
            }
            #textSiteURL {
                display: none;
            }
            form {
                display: inline-block;
            }
            #modal_wrapper.overlay:before {
                content: " ";
                width: 100%;
                height: 100%;
                position: fixed;
                z-index: 100;
                top: 0;
                left: 0;
                background: #000;
                background: rgba(0,0,0,0.7);
            }
            #modal_window {
                display: none;
                z-index: 200;
                position: fixed;
                left: 50%;
                top: 50%;
                width: 360px;
                padding: 10px 20px;
                background: #fff;
                border: 5px solid #999;
                border-radius: 10px;
                box-shadow: 0 0 10px rgba(0,0,0,0.5);
            }
            #modal_wrapper.overlay #modal_window {
                display: block;
            }
        </style>
    </head>
    <body>
        <div>
            <form action="index.html" method="get">
                <fieldset>
                    <legend>Query</legend>
                    <span>
                        <label for="textProduct">Product</label>
                        <input type="search" list="products-datalist" id="textProduct" name="product"></input>
                        <datalist id="products-datalist"></datalist>
                    </span>
                    <span>
                        <label for="textMilestone">Milestone</label>
                        <input type="search" list="milestones-datalist" id="textMilestone" name="milestone"></input>
                        <datalist id="milestones-datalist"></datalist>
                    </span>
                    <span>
                        <label for="textAssignee">Assignee</label>
                        <input type="search" list="assignees-datalist" id="textAssignee" name="assignee"></input>
                        <datalist id="assignees-datalist"></datalist>
                    </span>
                    <span>
                        <input type="text" id="textSiteURL" name="site"></input>
                    </span>
                    <span>
                        <button type="submit" id="btnSubmit">Submit</button>
                    </span>
                    <span id="spinner"></span>
                    <span id="whoami"></span>
                </fieldset>
                <fieldset>
                    <legend>Other</legend>
                    <span>
                        <button type="submit" id="btnCreate" target="_blank">Create</button>
                        <button id="modal_open">Sign In</button>
                    </span>
                </fieldset>
            </form>
            <span id="actions">
                <button id="btnCreate">Create Bug</button>
            </span>
        </div>
        <div id="board">
        </div>
        <div id="modal_wrapper">
            <div id="modal_window">
                <div style="text-align: right;"><a id="modal_close" href="#">close <b>X</b></a></div>
                <p>Please enter your Bugzilla credentials</p>
                <form id="modal_feedback" method="POST" action="#" accept-charset="UTF-8">
                    <p><label>Username<br>
                    <input type="text" autofocus required size="48" id="textUsername" name="username" value=""></label></p>
                    <p><label>Password<br>
                    <input type="password" required size="48" id="textPassword" name="password" value=""></label></p>
                    <p><input type="submit" name="btnAuthSubmit" value="Send"></p>
                </form>
            </div> <!-- #modal_window -->
        </div> <!-- #modal_wrapper -->
    </body>

        <script type="text/javascript">
            var bzComponent = "";
            var bzPriority = "";
            var bzAssignedTo = "";
            var bzOrder = "priority";
            var bzURL = "http://bugzilla.ddk.armysimulation.mil.ca";
            var userFullName = "";
            var fromStatus = "";
            var bugID = "";
            var bzProduct = "";
            var bzProductMilestone = "";

            window.onload = loadParams;

            function loadBoard() {
                clearBoard();
                startSpinner();
                doGET("/rest/field/bug/status/values", function(response) {
                    statuses = response.values;
                    for (var key in statuses) {
                        status = statuses[key];
                        addBoardColumn(status);
                    }
                    loadBugs();
                });
            }

            function addBoardColumn(status) {
                var div = document.createElement('div');
                div.id = status;
                div.setAttribute('ondragover', 'allowDrop(event)');
                div.setAttribute('ondrop', 'drop(event)');
                document.getElementById("board").appendChild(div);

                title = document.createElement('div');
                title.className = "board-column-title";
                title.innerHTML = status;
                document.getElementById(status).appendChild(title);
            }

            function addCard(bug) {
                var card = document.createElement('div');
                card.className = bug.severity + " " + bug.priority +" " + "card";

                var summary = document.createElement('div');
                summary.innerHTML = "<a href='" + bzURL + "/show_bug.cgi?id=" + bug.id + "'>#" + bug.id + "</a> " + bug.summary;

                var meta = document.createElement('div');
                meta.innerHTML = bug.assigned_to_detail.real_name;
                meta.className = "card-meta";

                card.appendChild(summary);
                card.appendChild(meta);
                document.getElementById(bug.status).appendChild(card);
                card.draggable = "true";
                card.setAttribute('ondragstart', 'drag(event)');
            }

            function clearBoard() {
                document.getElementById("board").innerHTML = "";
            }

            function clearMilestonesList() {
                var elem = document.getElementById("milestones-datalist");
                while (elem.firstChild) {
                    elem.removeChild(elem.firstChild);
                }
            }

            function loadParams() {
                bzProduct = getURLParameter('product');
                bzProductMilestone = getURLParameter('milestone');
                bzAssignedTo = getURLParameter('assignee');

                if (sessionStorage.userToken != null) {
                    getName();
                }

                // Allow the Bugzilla site URL to be overriden. Useful for testing.
                // For most permanent deployments just change the hardcodecoded bzURL.
                var site = getURLParameter('site');
                if (site != null) {
                    bzURL = site;
                    document.getElementById("textSiteURL").value = bzURL;
                }

                document.getElementById("textProduct").value = bzProduct;
                document.getElementById("textMilestone").value = bzProductMilestone;
                document.getElementById("textAssignee").value = bzAssignedTo

                loadProductsList();
                if (bzProduct != null) {
                    loadMilestonesList();
                    loadBoard();
                }
            }

            function loadBugs() {
                bzProduct = document.getElementById('textProduct').value;
                bzProductMilestone = document.getElementById('textMilestone').value;
                bzAssignedTo = document.getElementById('textAssignee').value;
                doGET("/rest/bug?product=" + bzProduct + "&include_fields=summary,status,id,severity,priority,assigned_to&order=" + bzOrder + "&target_milestone=" + bzProductMilestone + "&component=" + bzComponent + "&priority=" + bzPriority + "&assigned_to=" + bzAssignedTo, function(response) {
                    bugs = response.bugs;
                    for (var key in bugs) {
                        bug = bugs[key];
                        addCard(bug);
                    }
                    stopSpinner();
                });

            }

            function loadProductsList() {
                doGET("/rest/product?type=enterable&include_fields=name", function(response) {
                    var products = response.products;
                    for (var key in products) {
                        var product = products[key];
                        var option = document.createElement('option');
                        option.value = product.name;
                        document.getElementById("products-datalist").appendChild(option);
                    }
                });
            }

            function loadMilestonesList() {
                bzProduct = document.getElementById("textProduct").value;
                clearMilestonesList();
                doGET("/rest/product?names=" + bzProduct + "&include_fields=milestones", function(response) {
                    var milestones = response.products[0].milestones;
                    for (var key in milestones) {
                        var milestone = milestones[key];
                        var option = document.createElement('option');
                        option.value = milestone.name;
                        document.getElementById("milestones-datalist").appendChild(option);
                    }
                });
            }
			
            function getName() {
                doGET("/rest/user/" + sessionStorage.userID + "?token=" + sessionStorage.userToken, function(response) {
                    userFullName = response.users[0].real_name;
                    if (userFullName != null) {
                        document.getElementById("modal_open").style.display = 'none';
                        document.getElementById("modal_close").click();
                        document.getElementById("whoami").textContent = userFullName;
                    }
                });
            }

            function doGET(url, callback) {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        if (response == "") {
                            alert("Unable to access Bugzilla REST : " + bzURL);
                            return;
                        } else {
                            var obj = JSON.parse(response);
                            return callback(obj);
                        }
                    }
                }
                xhr.open("GET", bzURL + url);
                xhr.setRequestHeader("Accept", "application/json");
                xhr.send();
            }

            function getURLParameter(parameter) {
                return decodeURIComponent((new RegExp('[?|&]' + parameter + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
            }

            function startSpinner() {
                var i = document.createElement('i');
                i.className = "fa fa-cog fa-spin fa-lg"
                document.getElementById("spinner").appendChild(i);
            }

            function stopSpinner() {
                var elem = document.getElementById("spinner");
                elem.removeChild(elem.firstChild);
            }

            function doAuth(user, password) {
                doGET("/rest/login?login=" + user + "&password=" + password, function(response) {
                    if (response.code == '300') { // Invalid Username or Password, from Bugzilla web service doc
                        alert(response.message);
                    } else if (response.code == '301') { // Login Disabled, from Bugzilla web service doc
                        alert(response.message);
                    } else {
                        sessionStorage.userID = response.id;
                        sessionStorage.userToken = response.token;
                        getName();
                    }
                });
            }

            function writeBug(stat) {
                var urlAppend = "";
                // Check bug state matrix
                // Hardcoded for now, query GET /rest/field/bug/(id)
                // return.values.can_change_to
                switch (stat) {
                    case fromStatus:
                        // Changing to same status, do nothing
                        return;
                        break;
                    case "RESOLVED":
                    case "VERIFIED":
                        if (fromStatus == "CONFIRMED" ||  fromStatus == "IN_PROGRESS") {
                            // We need to set a resolution to be a valid bug change
                            var bugResolution = "FIXED"; // popup box with valid resolutions
                            var bugComment = ""; // previous box with comment ability
                            if (bugComment != "") {
                                urlAppend = "&resolution=" + bugResolution + "&comment=" + bugComment;
                            } else {
                                urlAppend = "&resolution=" + bugResolution;
                            }
				
                        }
                        break;
                    case "CONFIRMED":
                    case "IN_PROGRESS":
                        if (fromStatus == "RESOLVED" || fromStatus == "VERIFIED") {
                            // No need to set resolution to blank, automatically happens
                            var bugComment = ""; // Still ask for a comment
                            if (bugComment != "") {
                                urlAppend = "&comment=" + bugComment;
                            }
                        }
                        break;

                }

                // Now try the bug
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    //if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        var obj = JSON.parse(response);
                        if (obj.code == '410') {  // Requires us to sign in to write changes
                            alert(obj.message);
                            return;
                        } else {
                            loadBoard();
                    }
                    }
                }
                // TODO: maybe check if bugID != number
                xhr.open("PUT", bzURL + "/rest/bug/" + bugID + "?status=" + stat + urlAppend + "&token=" + sessionStorage.userToken);
                xhr.send();            }

            function allowDrop(ev) {
                ev.preventDefault();
            }

            function drag(ev) {
                ev.dataTransfer.setData("text", ev.target.id);
                fromStatus = ev.target.parentElement.id;
                var dragBugText = ev.currentTarget.innerText;
                var re = /[0-9]+/;
                bugID = re.exec(dragBugText);  
                bugID = bugID[0];
            }

            function drop(ev) {
                ev.preventDefault();
//                var data = ev.dataTransfer.getData("text");
//                ev.target.appendChild(document.getElementById(data));
                var target = ev.currentTarget;
                var targetColumn = target.id;
                writeBug(targetColumn);
            }

            // Register event handlers
            document.getElementById("textProduct").addEventListener("input", function() {
                // Clear any previous milestone selection.
                document.getElementById("textMilestone").value = "";
                loadMilestonesList();
                });

            document.getElementById("btnCreate").addEventListener("click", function() {
                var product = document.getElementById("textProduct").value;
                window.open(bzURL + "/enter_bug.cgi?product=" + product);
                });

            // Original JavaScript code by Chirp Internet: www.chirp.com.au
            // Please acknowledge use of this code by including this header.
            document.getElementById("modal_feedback").addEventListener("submit", function(e) {
                var form = this;
                e.preventDefault();
                doAuth(document.getElementById("textUsername").value, document.getElementById("textPassword").value);
                }, false);

            document.addEventListener("DOMContentLoaded", function() {
            	var modalWrapper = document.getElementById("modal_wrapper");
            	var modalWindow  = document.getElementById("modal_window");

            	var openModal = function(e)
            	{
            		modalWrapper.className = "overlay";
            		modalWindow.style.marginTop = (-modalWindow.offsetHeight)/2 + "px";
            		modalWindow.style.marginLeft = (-modalWindow.offsetWidth)/2 + "px";
            		e.preventDefault();
            	};

                var closeModal = function(e)
                {
                    modalWrapper.className = "";
                    e.preventDefault();
                };

                var clickHandler = function(e) {
                    if(e.target.tagName == "DIV") {
                        if(e.target.id != "modal_window") closeModal(e);
                    }
                };

                var keyHandler = function(e) {
                    if(e.keyCode == 27) closeModal(e);
                };

                document.getElementById("modal_open").addEventListener("click", openModal, false);
                document.getElementById("modal_close").addEventListener("click", closeModal, false);
                document.addEventListener("click", clickHandler, false);
                document.addEventListener("keydown", keyHandler, false);
                }, false);
            ////

        </script>
    </body>
</html>
