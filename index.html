<html>
    <head>
        <title>Bugzilla Kanban Board</title>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

        <style>
            body {
                background-color: ghostwhite;
                font-family: sans-serif;
            }
            #board {
                width: 100%;
                display: flex;
            }
            #board div {
                flex: 1;
                vertical-align: top;
            }
            .board-column-title {
                text-align: center;
                font-weight: bold;
                align-items: center;
            }
            .board-column {
            }
            .board-column.drag-card {
                outline-width: 2px;
                outline-style: dashed;
                outline-color: lightgrey;
            }
            .card {
                background-color: white;
                border-width: 1px;
                border-color: lightgrey;
                border-style: solid;
                padding: 10px;
                margin: 5px;
                font-size: small;
            }
            .card-meta {
                font-size: x-small;
                text-align: right;
                color: lightgrey;
                padding-top: 5px;
            }
            .card:hover {
                box-shadow: 0px 0px 1px grey;
            }
            .enhancement {
                border-right-color: greenyellow;
                border-right-width: 4px;
                border-right-style: solid;
            }
            .critical {
                border-right-color: red;
                border-right-width: 4px;
                border-right-style: solid;
            }
            .P1 {
                border-left-color: orange;
                border-left-width: 4px;
                border-left-style: solid;
            }
            fieldset {
                border-width: 1;
                border-style: solid;
                border-color: lightgrey;
                background-color: white;
            }
            #textSiteURL {
                display: none;
            }
            #queryForm {
                display: inline-block;
            }
            #loginForm {
                display: none;
            }
            .resolution {
                height: 5%;
                background: darkgray;
                color: black;
                text-align: -webkit-center;
                border: thin solid black;
                margin-top: 10px;
                padding: 10px;
                margin: 5px;
                font-size: small;
            }
        </style>
    </head>
    <body>
        <div>
            <form id="queryForm" action="index.html" method="get">
                <fieldset>
                    <legend>Query</legend>
                    <span>
                        <label for="textProduct">Product</label>
                        <input type="search" list="products-datalist" id="textProduct" name="product"></input>
                        <datalist id="products-datalist"></datalist>
                    </span>
                    <span>
                        <label for="textMilestone">Milestone</label>
                        <input type="search" list="milestones-datalist" id="textMilestone" name="milestone"></input>
                        <datalist id="milestones-datalist"></datalist>
                    </span>
                    <span>
                        <label for="textAssignee">Assignee</label>
                        <input type="search" list="assignees-datalist" id="textAssignee" name="assignee"></input>
                        <datalist id="assignees-datalist"></datalist>
                    </span>
                    <span>
                        <input type="text" id="textSiteURL" name="site"></input>
                    </span>
                    <button type="submit" id="btnSubmit">Submit</button>
                    <span id="spinner"></span>
                </fieldset>
            </form>
            <form id="loginForm">
                <fieldset>
                    <legend>Login</legend>
                    <span>
                        <label for="textUserName">Username</label>
                        <input type="text" required id="textUsername" name="username" value="">
                    </span>
                    <span>
                        <label for="textPassword" >Password</label>
                        <input type="password" required id="textPassword" name="password" value="">
                    </span>
                    <input type="button" id="btnAuthSubmit" value="Send">
                </fieldset>
            </form>
            <span id="actions">
                <button id="btnCreate">Create Bug</button>
                <span id="whoami"></span>
                <button id="btnSignIn">Sign In</button>
            </span>
        </div>
        <div id="board">
        </div>

        <script type="text/javascript">
            var bzComponent = "";
            var bzPriority = "";
            var bzAssignedTo = "";
            var bzOrder = "priority";
            var bzURL = "http://bugzilla.ddk.armysimulation.mil.ca";
            var userFullName = "";
            var bzProduct = "";
            var bzProductMilestone = "";

            window.onload = loadParams;

            function loadBoard() {
                clearBoard();
                startSpinner();
                doGET("/rest/field/bug/status/values", function(response) {
                    statuses = response.values;
                    for (var key in statuses) {
                        status = statuses[key];
                        addBoardColumn(status);
                    }
                    doGET("/rest/product/" + bzProduct + "?include_fields=has_unconfirmed", function(response) {
                        if (!(response.products[0].has_unconfirmed)) {
                            document.getElementsByClassName("board-column").UNCONFIRMED.hidden = true;
                        }
                    });
                    loadBugs();
                });
            }

            function addBoardColumn(status) {
                var div = document.createElement('div');
                div.className = "board-column";
                div.id = status;
                if (isLoggedIn()) {
                    div.addEventListener('drag', dragCardStart);
                    div.addEventListener('dragend', dragCardEnd);
                    div.addEventListener('dragover', dragCardOver);
                    div.addEventListener('drop', dropCard);
                    div.addEventListener('dragenter', dragCardEnter);
                    div.addEventListener('dragleave', dragCardLeave);
                }
                document.getElementById("board").appendChild(div);

                title = document.createElement('div');
                title.className = "board-column-title";
                title.innerHTML = status;
                document.getElementById(status).appendChild(title);
            }

            function addCard(bug) {
                var card = document.createElement('div');
                card.className = bug.severity + " " + bug.priority +" " + "card";
                card.id = "card-" + bug.id;

                var summary = document.createElement('div');
                summary.innerHTML = "<a href='" + bzURL + "/show_bug.cgi?id=" + bug.id + "'>#" + bug.id + "</a> " + bug.summary;

                var meta = document.createElement('div');
                meta.innerHTML = bug.assigned_to_detail.real_name;
                meta.className = "card-meta";

                card.appendChild(summary);
                card.appendChild(meta);

                if (isLoggedIn()) {
                    card.draggable = "true";
                    card.addEventListener('dragstart', dragCard);
                }

                document.getElementById(bug.status).appendChild(card);
            }

            function clearBoard() {
                document.getElementById("board").innerHTML = "";
            }

            function clearMilestonesList() {
                var elem = document.getElementById("milestones-datalist");
                while (elem.firstChild) {
                    elem.removeChild(elem.firstChild);
                }
            }

            function loadParams() {
                bzProduct = getURLParameter('product');
                bzProductMilestone = getURLParameter('milestone');
                bzAssignedTo = getURLParameter('assignee');

                if (isLoggedIn()) {
                    loadName();
                    hideSignInButton();
                }

                // Allow the Bugzilla site URL to be overriden. Useful for testing.
                // For most permanent deployments just change the hardcodecoded bzURL.
                var site = getURLParameter('site');
                if (site != null) {
                    bzURL = site;
                    document.getElementById("textSiteURL").value = bzURL;
                }

                document.getElementById("textProduct").value = bzProduct;
                document.getElementById("textMilestone").value = bzProductMilestone;
                document.getElementById("textAssignee").value = bzAssignedTo

                loadProductsList();
                if (bzProduct != null) {
                    loadMilestonesList();
                    loadBoard();
                }
            }

            function loadBugs() {
                bzProduct = document.getElementById('textProduct').value;
                bzProductMilestone = document.getElementById('textMilestone').value;
                bzAssignedTo = document.getElementById('textAssignee').value;
                doGET("/rest/bug?product=" + bzProduct + "&include_fields=summary,status,id,severity,priority,assigned_to&order=" + bzOrder + "&target_milestone=" + bzProductMilestone + "&component=" + bzComponent + "&priority=" + bzPriority + "&assigned_to=" + bzAssignedTo, function(response) {
                    bugs = response.bugs;
                    for (var key in bugs) {
                        bug = bugs[key];
                        addCard(bug);
                    }
                    if (isLoggedIn()) {
                        loadResolutions();
                    }
                    stopSpinner();
                });

            }

            function loadProductsList() {
                doGET("/rest/product?type=enterable&include_fields=name", function(response) {
                    var products = response.products;
                    for (var key in products) {
                        var product = products[key];
                        var option = document.createElement('option');
                        option.value = product.name;
                        document.getElementById("products-datalist").appendChild(option);
                    }
                });
            }

            function loadMilestonesList() {
                bzProduct = document.getElementById("textProduct").value;
                clearMilestonesList();
                doGET("/rest/product?names=" + bzProduct + "&include_fields=milestones", function(response) {
                    var milestones = response.products[0].milestones;
                    for (var key in milestones) {
                        var milestone = milestones[key];
                        var option = document.createElement('option');
                        option.value = milestone.name;
                        document.getElementById("milestones-datalist").appendChild(option);
                    }
                });
            }
			
            function loadName() {
                doGET("/rest/user/" + sessionStorage.userID + "?token=" + sessionStorage.userToken, function(response) {
                    userFullName = response.users[0].real_name;
                    if (userFullName != null) {
                        document.getElementById("whoami").textContent = userFullName;
                    }
                });
            }

            function doGET(url, callback) {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        if (response == "") {
                            alert("Unable to access Bugzilla REST : " + bzURL);
                            return;
                        } else {
                            var obj = JSON.parse(response);
                            if (obj.error != null) {
                                alert(obj.message);
                            } else {
                                return callback(obj);
                            }
                        }
                    }
                }
                xhr.open("GET", bzURL + url);
                xhr.setRequestHeader("Accept", "application/json");
                xhr.send();
            }

            function getURLParameter(parameter) {
                return decodeURIComponent((new RegExp('[?|&]' + parameter + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
            }

            function startSpinner() {
                var i = document.createElement('i');
                i.className = "fa fa-cog fa-spin fa-lg"
                document.getElementById("spinner").appendChild(i);
            }

            function stopSpinner() {
                var elem = document.getElementById("spinner");
                elem.removeChild(elem.firstChild);
            }

            function doAuth(user, password) {
                doGET("/rest/login?login=" + user + "&password=" + password, function(response) {
                    if (response.code == '300') { // Invalid Username or Password, from Bugzilla web service doc
                        alert(response.message);
                    } else if (response.code == '301') { // Login Disabled, from Bugzilla web service doc
                        alert(response.message);
                    } else {
                        sessionStorage.userID = response.id;
                        sessionStorage.userToken = response.token;
                        loadName();
                        if (bzProduct != null) {
                            loadMilestonesList();
                            loadBoard();
                        }
                        hideLoginForm();
                    }
                });
            }

            function isLoggedIn() {
                return sessionStorage.userToken != null;
            }

            function showLoginForm() {
                var elem = document.getElementById("loginForm");
                elem.style.display = "inline-block";
                hideSignInButton();
            }

            function hideLoginForm() {
                var elem = document.getElementById("loginForm");
                elem.style.display = "none";
            }


            function hideSignInButton() {
                document.getElementById("btnSignIn").style.display = "none";
            }

            function writeBug(bugID, fromStatus, targetStatus, bugResolution) {
                var urlAppend = "";
                switch (targetStatus) {
                    case "RESOLVED":
                        // Only column we allow same state changes
                        var bugComment = ""; // TODO: Comment box popup
                        if (bugComment != "") {
                            urlAppend = "&resolution=" + bugResolution + "&comment=" + bugComment;
                        } else {
                            urlAppend = "&resolution=" + bugResolution;
                        }
                        break;
                    case fromStatus:
                        // Changing to same status, do nothing
                        return;
                        break;
                    case "VERIFIED":
                        // Assume resolution is valid from RESOLVED state
                        doGET("/rest/bug/" + bugID, function(response) {
                            bugResolution = response.bugs[0].resolution;
                        });
                        // else is set to board-column title (invalid, throw error, do nothing)
                        break;
                    case "CONFIRMED":
                    case "IN_PROGRESS":
                        if (fromStatus == "RESOLVED" || fromStatus == "VERIFIED") {
                            // No need to set resolution to blank, automatically happens
                            var bugComment = ""; // TODO: Comment box popup
                            if (bugComment != "") {
                                urlAppend = "&comment=" + bugComment;
                            }
                        }
                        break;
                }

                // Now try the bug
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    //if (xhr.readyState == 4 && xhr.status == 200) {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        var obj = JSON.parse(response);
                        if (obj.error != null) {
                            alert(obj.message);
                            return;
                        } else {
                            loadBoard();
                        }
                    }
                }
                // TODO: maybe check if bugID != number
                xhr.open("PUT", bzURL + "/rest/bug/" + bugID + "?status=" + targetStatus + urlAppend + "&token=" + sessionStorage.userToken);
                xhr.send();
            }

            function dragCardOver(ev) {
                ev.preventDefault();
            }

            function dragCardEnter(ev) {
                ev.preventDefault();

                var bugData = JSON.parse(ev.dataTransfer.getData("text"));
                if (bugData.status != ev.currentTarget.id) {
                    ev.currentTarget.classList.add("drag-card");
                }
            }

            function dragCardLeave(ev) {
                ev.currentTarget.classList.remove("drag-card");
            }

            function dragCard(ev) {

                var fromStatus = ev.target.parentElement.id;

                // Disable pointer-events for all other cards so that we
                // can reliably detect when a card enters and leaves a column.
                var cards = document.getElementsByClassName("card");
                for (var i = 0; i < cards.length; i++) {
                    if (cards[i].id != ev.currentTarget.id) {
                        cards[i].style.pointerEvents = "none";
                    }
                }

                var dragBugText = ev.currentTarget.innerText;
                var re = /[0-9]+/;
                var bugID = re.exec(dragBugText);
                bugID = bugID[0];

                var bugData = {"id": bugID, "status": fromStatus};
                ev.dataTransfer.setData("text", JSON.stringify(bugData));
            }

            function dragCardStart(ev) {
                showResolutions(document.getElementById("RESOLVED"));
            }

            function dragCardEnd(ev) {
                hideResolutions(document.getElementById("RESOLVED"));
            }

            function dropCard(ev) {
                // Re-enable pointer events for all cards.
                var cards = document.getElementsByClassName("card");
                for (var i = 0; i < cards.length; i++) {
                    cards[i].style.pointerEvents = "auto";
                }

                ev.currentTarget.classList.remove("drag-card");

                ev.preventDefault();

                var bugData = JSON.parse(ev.dataTransfer.getData("text"));

                var targetStatus = ev.currentTarget.id;
                var targetResolution = ev.target.id;

                writeBug(bugData.id, bugData.status, targetStatus, targetResolution);
            }

            function loadResolutions() {
                doGET("/rest/field/bug/resolution", function(response) {
                    var arrayResolutions = response.fields;

                    var resolutions = document.createElement("div");
                    resolutions.className = "resolutions";
                    resolutions.hidden = true;

                    for (var i = 0;  i < arrayResolutions[0].values.length; i++) {
                        var resolutionName = arrayResolutions[0].values[i].name;
                        if (resolutionName != "") {
                            var box = document.createElement("div");
                            box.className = "resolution";
                            box.innerText += resolutionName;
                            box.id = resolutionName;
                            resolutions.appendChild(box);
                        }
                    }

                    document.getElementById("RESOLVED").appendChild(resolutions);
                });
            }

            function showResolutions(elem) {
                var resolutions = elem.getElementsByClassName("resolutions");
                for (var i = 0; i < resolutions.length; i++) {
                    resolutions[i].hidden = false;
                }
                toggleCards(elem, true);
            }

            function hideResolutions(elem) {
                var resolutions = elem.getElementsByClassName("resolutions");
                for (var i = 0; i < resolutions.length; i++) {
                    resolutions[i].hidden = true;
                }
                toggleCards(elem, false);
            }

            function toggleCards(elem, state) {
                var cards = elem.getElementsByClassName("card");
                for (var i = 0; i < cards.length; i++) {
                    cards[i].hidden = state;
                }
            }

            // Register event handlers
            document.getElementById("textProduct").addEventListener("input", function() {
                // Clear any previous milestone selection.
                document.getElementById("textMilestone").value = "";
                loadMilestonesList();
                });

            document.getElementById("btnCreate").addEventListener("click", function() {
                var product = document.getElementById("textProduct").value;
                window.open(bzURL + "/enter_bug.cgi?product=" + product);
                });

            document.getElementById("btnSignIn").addEventListener("click", function() {
                showLoginForm();
                });

            document.getElementById("btnAuthSubmit").addEventListener("click", function() {
                var user = document.getElementById("textUsername").value;
                var password = document.getElementById("textPassword").value;
                doAuth(user, password);
                });


        </script>
    </body>
</html>
