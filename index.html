<html>
    <body>
        <div>
            <form action="index.html" method="get">
                <span>
                    <label for="textProduct">Product</label>
                    <input list="products-datalist" id="textProduct" name="product"></input>
                    <datalist id="products-datalist"></datalist>
                </span>
                <span>
                    <label for="textMilestone">Milestone</label>
                    <input list="milestones-datalist" id="textMilestone" name="milestone"></input>
                    <datalist id="milestones-datalist"></datalist>
                </span>
                <span>
                    <button type="submit" id="btnSubmit">Submit</button>
                </span>
            </form>
        </div>
        <table id="board">
            <tr id="board-headings"></tr>
            <tr id="board-cards"></tr>
        </table>
    </body>
    <head>
        <script type="text/javascript">
            var bzComponent = ""
            var bzPriority = ""
            var bzAssignedTo = ""
            var bzOrder = "priority"
            var bzURL = "http://bugzilla.ddk.armysimulation.mil.ca"
            var sessionToken = "";
            var bzProduct = "";
            var bzProductMilestone = ""

            window.onload = loadParams;

            function loadBoard() {
                clearBoard();
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        var obj = JSON.parse(response);
                        statuses = obj.values;
                        for (var key in statuses) {
                            status = statuses[key];
                            addBoardColumn(status);
                        }


                        loadBugs();
                    }
                }
                xhr.open("GET", bzURL + "/rest/field/bug/status/values");
                xhr.send();
            }

            function loadBugs() {
                bzProduct = document.getElementById('textProduct').value;
                bzProductMilestone = document.getElementById('textMilestone').value;
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        var obj = JSON.parse(response);
                        bugs = obj.bugs;
                        for (var key in bugs) {
                            bug = bugs[key];
                            addCard(bug);
                        }
                    }
                }
                xhr.open("GET", bzURL + "/rest/bug?product=" + bzProduct + "&include_fields=summary,status,id,severity,priority&order=" + bzOrder + "&target_milestone=" + bzProductMilestone + "&component=" + bzComponent + "&priority=" + bzPriority + "&assigned_to=" + bzAssignedTo);
                xhr.send();
            }

            function addBoardColumn(status) {
                var th = document.createElement('th');
                th.innerHTML = status;
                document.getElementById("board-headings").appendChild(th);

                var td = document.createElement('td');
                td.id = status;
                document.getElementById("board-cards").appendChild(td);
            }

            function addCard(bug) {
                var div = document.createElement('div');
                div.className = bug.severity + " " + bug.priority +" " + "card";
                div.innerHTML = "<a href='" + bzURL + "/show_bug.cgi?id=" + bug.id + "'>#" + bug.id + "</a> " + bug.summary;
                document.getElementById(bug.status).appendChild(div);
            }

            function clearBoard() {
                document.getElementById("board-headings").innerHTML = "";
                document.getElementById("board-cards").innerHTML = "";
            }

            function clearMilestonesList() {
                var elem = document.getElementById("milestones-datalist");
                while (elem.firstChild) {
                    elem.removeChild(elem.firstChild);
                }
            }

            function loadParams() {
                bzProduct = getURLParameter('product');
                bzProductMilestone = getURLParameter('milestone');
                document.getElementById("textProduct").value = bzProduct;
                document.getElementById("textMilestone").value = bzProductMilestone;

                loadProductsList();
                if (bzProduct != null) {
                    loadMilestonesList();
                    loadBoard();
                }
            }

            function loadProductsList() {
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        var obj = JSON.parse(response);
                        var products = obj.products;
                        for (var key in products) {
                            var product = products[key];
                            var option = document.createElement('option');
                            option.value = product.name;
                            document.getElementById("products-datalist").appendChild(option);
                        }
                    }
                }
                xhr.open("GET", bzURL + "/rest/product?type=enterable&include_fields=name");
                xhr.send();
            }

            function loadMilestonesList() {
                bzProduct = document.getElementById("textProduct").value;
                clearMilestonesList();
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == XMLHttpRequest.DONE) {
                        var response = xhr.responseText;
                        var obj = JSON.parse(response);
                        var milestones = obj.products[0].milestones;
                        for (var key in milestones) {
                            var milestone = milestones[key];
                            var option = document.createElement('option');
                            option.value = milestone.name;
                            document.getElementById("milestones-datalist").appendChild(option);
                        }
                    }
                }
                xhr.open("GET", bzURL + "/rest/product?names=" + bzProduct + "&include_fields=milestones");
                xhr.send();
            }

            function getURLParameter(parameter) {
                return decodeURIComponent((new RegExp('[?|&]' + parameter + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null;
            }

            // Register event handlers
            document.getElementById("textProduct").addEventListener("input", function() {
                // Clear any previous milestone selection.
                document.getElementById("textMilestone").value = "";
                loadMilestonesList();
                });
        </script>
        <style>
            body {
                background-color: ghostwhite;
            }
            #board {
                width: 100%;
                table-layout: fixed;
            }
            .card {
                background-color: white;
                border-width: 1px;
                border-color: black;
                border-style: dotted;
                padding: 5px;
                margin: 2px;
            }
            .enhancement {
                border-right-color: greenyellow;
                border-right-width: 4px;
                border-right-style: solid;
            }
            .critical {
                border-right-color: red;
                border-right-width: 4px;
                border-right-style: solid;
            }
            .P1 {
                border-left-color: orange;
                border-left-width: 4px;
                border-left-style: solid;
            }
            #board-cards {
                vertical-align: top;
            }
        </style>
    </head>
</html>
